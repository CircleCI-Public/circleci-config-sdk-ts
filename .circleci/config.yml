version: 2.1
orbs:
  node: circleci/node@4.2

commands:
  update-version:
    description: Updates the version in the package.json file to match the tag.
    steps:
      - run:
          name: Set Package Version
          command:
            jq --arg semver "$CIRCLE_TAG" '.version = "$semver"' package.json >
            modified.package.json && mv modified.package.json  package.json

jobs:
  deploy-docs:
    executor: node/default
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - 'fe:98:73:d4:14:87:89:62:38:63:9f:be:33:14:32:01'
      - node/install-packages
      - update-version
      - run:
          name: Build Docs
          command: npm run build:docs
      - run:
          name: Deploy Docs
          command: |
            cd docs
            git config --global user.email "community-partner@circleci.com"
            git config --global user.name "orb-publisher"
            git init
            git add -A
            git commit -m "Deploy-<<pipeline.git.branch>>-<<pipeline.number>> [ci skip]"
            git push -f git@github.com:CircleCI-Public/circleci-config-sdk-ts.git master:gh-pages
  deploy-package:
    executor: node/default
    steps:
      - checkout
      - node/install-packages
      - update-version
      - run:
          name: Build NPM Module
          command: npm run build
      - run:
          name: Publish NPM Module
          command: |
            # Set NPM Auth
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            # Publish
            npm publish --access restricted
workflows:
  test:
    jobs:
      - node/test:
          name: lint
          run-command: lint:ci
          version: 15.14.0
          filters:
            tags:
              only: /.*/
      - node/test:
          matrix:
            parameters:
              version:
                - 15.14.0
                - 14.16.1
                - 13.14.0
          filters:
            tags:
              only: /.*/
      - deploy-docs:
          requires:
            - node/test
            - lint
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+$/
      - deploy-package:
          context: CONFIG_SDK_PUBLISHING
          requires:
            - node/test
            - lint
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+$/
